<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT for Programming Lab</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <style>
        .container { max-width: 800px; margin: auto; }
        #description { background: #f4f4f4; padding: 15px; border-left: 5px solid #007bff; border-radius: 4px; margin-bottom: 20px; color: #333; }
        #description h3 { margin-top: 0; }
        #description .section { margin: 10px 0; }
        #description .section-label { font-weight: bold; color: #007bff; }
        #description code { background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', Courier, monospace; }
        #description pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; overflow-x: auto; }
        textarea { font-family: 'Courier New', Courier, monospace; }
        #output { margin-top: 20px; white-space: pre-wrap; background: #222; color: #eee; padding: 15px; border-radius: 5px; min-height: 50px; border: 2px solid #444; }
        .loading { display: none; text-align: center; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>GPT Programming Lab: 5-Minute Sprints</h1>
        
        <label for="taskId">Select Task:</label>
        <select id="taskId" onchange="updateTaskDescription()">
            <option value="">Loading tasks...</option>
        </select>

        <div id="description">
            <p>Loading task information...</p>
        </div>

        <label for="lang">Language:</label>
        <select id="lang" onchange="updateTaskDescription()">
            <option value="python">Python</option>
            <option value="octave">MATLAB/Octave</option>
        </select>

        <label for="code">Paste GPT Output:</label>
        <textarea id="code" style="width:100%; height:300px;" placeholder="Paste the code generated by the LLM here..."></textarea>
        
        <button onclick="checkCode()" style="width:100%; margin-top: 10px;">Verify Solution</button>

        <div id="loading" class="loading">Running validation...</div>
        <pre id="output"></pre>
    </div>

    <script>
        let tasks = {};

        async function loadTasks() {
            try {
                const res = await fetch('/tasks');
                const data = await res.json();
                tasks = {};
                const select = document.getElementById('taskId');
                select.innerHTML = '';
                
                data.tasks.forEach(task => {
                    tasks[task.id] = task;
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = `${task.id}. ${task.title}`;
                    select.appendChild(option);
                });
                
                if (data.tasks.length > 0) {
                    select.value = data.tasks[0].id;
                    updateTaskDescription();
                }
            } catch (e) {
                document.getElementById('description').innerHTML = '<p style="color: red;">Error loading tasks from server.</p>';
            }
        }

        function updateTaskDescription() {
            const id = parseInt(document.getElementById('taskId').value);
            const task = tasks[id];
            if (!task) return;
            
            const lang = document.getElementById('lang').value;
            const desc = document.getElementById('description');
            let html = `<h3>${task.id}. ${task.title}</h3>`;
            
            if (task.asset_text || task.asset_code_python || task.asset_code_matlab) {
                html += '<div class="section"><span class="section-label">Asset:</span><div>';
                if (task.asset_text) {
                    html += `<pre>${escapeHtml(task.asset_text)}</pre>`;
                    if (task.asset_filename) {
                        html += `<p style="margin-top: 10px; padding: 8px; background: #e7f3ff; border-left: 3px solid #2196F3; border-radius: 3px;"><strong>üìÅ File available:</strong> The asset data is available as <code>${escapeHtml(task.asset_filename)}</code> in the current working directory.</p>`;
                    }
                }
                if (lang === 'python' && task.asset_code_python) {
                    html += `<p><strong>Python:</strong></p><pre><code>${escapeHtml(task.asset_code_python)}</code></pre>`;
                }
                if (lang === 'octave' && task.asset_code_matlab) {
                    html += `<p><strong>MATLAB:</strong></p><pre><code>${escapeHtml(task.asset_code_matlab)}</code></pre>`;
                }
                html += '</div></div>';
            }
            
            html += `<div class="section"><span class="section-label">Goal:</span> ${escapeHtml(task.goal)}</div>`;
            html += `<div class="section"><span class="section-label">Challenge:</span> ${escapeHtml(task.challenge)}</div>`;
            
            desc.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadTasks();

        async function checkCode() {
            const out = document.getElementById('output');
            const loading = document.getElementById('loading');
            out.innerText = "";
            out.style.borderColor = "#444";
            loading.style.display = "block";
            
            try {
                const res = await fetch('/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_id: parseInt(document.getElementById('taskId').value),
                        code: document.getElementById('code').value,
                        language: document.getElementById('lang').value
                    })
                });
                const data = await res.json();
                out.innerText = `${data.message}\n\nSTDOUT:\n${data.output || ''}\n\nDETAILS:\n${data.details || ''}`;
                out.style.borderColor = data.status === "success" ? "#28a745" : "#dc3545";
            } catch (e) {
                out.innerText = "Error communicating with server.";
                out.style.borderColor = "#dc3545";
            } finally {
                loading.style.display = "none";
            }
        }
    </script>
</body>
</html>
